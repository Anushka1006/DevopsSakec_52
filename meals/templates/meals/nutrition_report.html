{% extends 'meals/base.html' %}
{% load meal_extras %}

{% block title %}Nutrition Report - School Lunch Monitoring System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Nutrition Report</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
    </div>
</div>

<!-- Overall Nutrition Summary -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-pie-chart me-1"></i> Overall Nutrition Summary
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>Average Daily Calories</h5>
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: 100%" 
                         aria-valuenow="100" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ avg_calories|default:0|floatformat:0 }} kcal
                    </div>
                </div>
                
                <h5>Nutritional Balance</h5>
                <div class="row">
                    <div class="col-md-4">
                        <p class="mb-1">Proteins</p>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: {{ avg_protein|default:0|floatformat:0 }}%"
                                 aria-valuenow="{{ avg_protein|default:0|floatformat:0 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ avg_protein|default:0|floatformat:1 }}g
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1">Carbs</p>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-warning" role="progressbar" 
                                 style="width: {{ avg_carbs|default:0|floatformat:0 }}%"
                                 aria-valuenow="{{ avg_carbs|default:0|floatformat:0 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ avg_carbs|default:0|floatformat:1 }}g
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1">Fats</p>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-info" role="progressbar" 
                                 style="width: {{ avg_fats|default:0|floatformat:0 }}%"
                                 aria-valuenow="{{ avg_fats|default:0|floatformat:0 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ avg_fats|default:0|floatformat:1 }}g
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h5>Key Nutrients</h5>
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td>Fiber</td>
                            <td>{{ average_fiber|default:"0" }}g</td>
                        </tr>
                        <tr>
                            <td>Sodium</td>
                            <td>{{ average_sodium|default:"0" }}mg</td>
                        </tr>
                        <tr>
                            <td>Sugar</td>
                            <td>{{ average_sugar|default:"0" }}g</td>
                        </tr>
                        <tr>
                            <td>Iron</td>
                            <td>{{ average_iron|default:"0" }}mg</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Meal Type Analysis -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-grid-3x3-gap me-1"></i> Nutrition by Meal Type
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Breakfast -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Breakfast</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Calories
                                <span class="badge bg-primary rounded-pill">{{ breakfast_avg.calories|default:"0" }} kcal</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Protein
                                <span class="badge bg-primary rounded-pill">{{ breakfast_avg.protein|default:"0" }}g</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Carbs
                                <span class="badge bg-primary rounded-pill">{{ breakfast_avg.carbs|default:"0" }}g</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Fats
                                <span class="badge bg-primary rounded-pill">{{ breakfast_avg.fats|default:"0" }}g</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Lunch -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">Lunch</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Calories
                                <span class="badge bg-success rounded-pill">{{ lunch_avg.calories|default:"0" }} kcal</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Protein
                                <span class="badge bg-success rounded-pill">{{ lunch_avg.protein|default:"0" }}g</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Carbs
                                <span class="badge bg-success rounded-pill">{{ lunch_avg.carbs|default:"0" }}g</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Fats
                                <span class="badge bg-success rounded-pill">{{ lunch_avg.fats|default:"0" }}g</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Snack -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">Snack</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Calories
                                <span class="badge bg-warning text-dark rounded-pill">{{ snack_avg.calories|default:"0" }} kcal</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Protein
                                <span class="badge bg-warning text-dark rounded-pill">{{ snack_avg.protein|default:"0" }}g</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Carbs
                                <span class="badge bg-warning text-dark rounded-pill">{{ snack_avg.carbs|default:"0" }}g</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Fats
                                <span class="badge bg-warning text-dark rounded-pill">{{ snack_avg.fats|default:"0" }}g</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Meal List -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-list-ul me-1"></i> All Meals Nutrition Data
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Meal Name</th>
                        <th>Type</th>
                        <th>Calories</th>
                        <th>Protein</th>
                        <th>Carbs</th>
                        <th>Fats</th>
                    </tr>
                </thead>
                <tbody>
                    {% for meal in meals %}
                    <tr>
                        <td>{{ meal.name }}</td>
                        <td>{{ meal.meal_type|title }}</td>
                        <td>{{ meal.calories|default:"0" }} kcal</td>
                        <td>{{ meal.protein|default:"0" }}g</td>
                        <td>{{ meal.carbohydrates|default:"0" }}g</td>
                        <td>{{ meal.fats|default:"0" }}g</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Meal Type Analysis -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-bar-chart me-1"></i> Meal Type Analysis
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Meal Type</th>
                        <th>Average Calories</th>
                        <th>Protein (g)</th>
                        <th>Carbs (g)</th>
                        <th>Fats (g)</th>
                        <th>Most Common Items</th>
                    </tr>
                </thead>
                <tbody>
                    {% for meal_type in meal_type_analysis %}
                    <tr>
                        <td>{{ meal_type.name }}</td>
                        <td>{{ meal_type.avg_calories|default:0|floatformat:0 }}</td>
                        <td>{{ meal_type.avg_protein|default:0|floatformat:1 }}</td>
                        <td>{{ meal_type.avg_carbs|default:0|floatformat:1 }}</td>
                        <td>{{ meal_type.avg_fats|default:0|floatformat:1 }}</td>
                        <td>{{ meal_type.common_items|default:"-"|truncatechars:30 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Dietary Requirements Compliance -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-check-circle me-1"></i> Dietary Requirements Compliance
    </div>
    <div class="card-body">
        <div class="row">
            {% for requirement in dietary_requirements|default:"" %}
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">{{ requirement.name }}</h5>
                        <div class="progress mb-2">
                            <div class="progress-bar {% if requirement.compliance >= 90 %}bg-success{% elif requirement.compliance >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ requirement.compliance|default:0|floatformat:0 }}%"
                                 aria-valuenow="{{ requirement.compliance|default:0|floatformat:0 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ requirement.compliance|default:0|floatformat:0 }}%
                            </div>
                        </div>
                        <p class="card-text small">{{ requirement.description|default:"No description provided." }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // JavaScript if needed
    });
</script>
{% endblock %}
